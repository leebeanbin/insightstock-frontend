// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String?  @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  conversations Conversation[]
  portfolios    Portfolio[]
  favorites     Favorite[]
  history       History[]
  notes         Note[]
  learnings     Learning[]

  @@map("users")
}

// ============================================
// Stock & Market Data
// ============================================

model Stock {
  id          String   @id @default(uuid())
  code        String   @unique // 종목 코드 (예: 005930)
  name        String   // 종목명
  market      String   // KOSPI, KOSDAQ, NYSE, NASDAQ 등
  sector      String?
  currentPrice Float   @default(0)
  change      Float    @default(0)
  changeRate  Float    @default(0)
  volume      BigInt   @default(0)
  marketCap   BigInt?
  currency    String   @default("KRW") // KRW, USD
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  prices      StockPrice[]
  portfolios  Portfolio[]
  favorites   Favorite[]
  history     History[]
  news        NewsStock[]

  @@index([code])
  @@index([market])
  @@index([sector])
  @@map("stocks")
}

model StockPrice {
  id        String   @id @default(uuid())
  stockId   String
  date      DateTime
  open      Float
  high      Float
  low       Float
  close     Float
  volume    BigInt
  change    Float    @default(0)
  changeRate Float   @default(0)
  createdAt DateTime @default(now())

  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([stockId, date])
  @@index([stockId, date])
  @@map("stock_prices")
}

// ============================================
// News
// ============================================

model News {
  id           String   @id @default(uuid())
  title        String
  content      String   @db.Text
  summary      String?  @db.Text
  source       String
  url          String?  @unique
  publishedAt  DateTime
  sentiment    String?  // positive, negative, neutral
  sentimentScore Float?
  thumbnailUrl String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stocks      NewsStock[]
  keyPoints   NewsKeyPoint[]
  concepts    NewsConcept[]

  @@index([publishedAt])
  @@index([sentiment])
  @@map("news")
}

model NewsStock {
  id      String @id @default(uuid())
  newsId  String
  stockId String

  news  News  @relation(fields: [newsId], references: [id], onDelete: Cascade)
  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([newsId, stockId])
  @@index([newsId])
  @@index([stockId])
  @@map("news_stocks")
}

model NewsKeyPoint {
  id      String @id @default(uuid())
  newsId  String
  content String @db.Text

  news News @relation(fields: [newsId], references: [id], onDelete: Cascade)

  @@index([newsId])
  @@map("news_key_points")
}

model NewsConcept {
  id      String @id @default(uuid())
  newsId  String
  concept String

  news News @relation(fields: [newsId], references: [id], onDelete: Cascade)

  @@index([newsId])
  @@map("news_concepts")
}

// ============================================
// AI Chat
// ============================================

model Conversation {
  id        String   @id @default(uuid())
  userId    String
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  role           String   // user, assistant
  content        String   @db.Text
  sources        String[] // 관련 출처 URL 배열
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============================================
// Portfolio
// ============================================

model Portfolio {
  id           String   @id @default(uuid())
  userId       String
  stockId      String
  quantity     Float
  averagePrice Float
  totalCost    Float    // quantity * averagePrice
  currentValue Float    // quantity * currentPrice (계산)
  profit       Float    // currentValue - totalCost
  profitRate   Float    // (profit / totalCost) * 100
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([userId, stockId]) // 같은 종목은 한 번만 추가 가능
  @@index([userId])
  @@index([stockId])
  @@map("portfolios")
}

// ============================================
// Favorites & History
// ============================================

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  stockId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@unique([userId, stockId])
  @@index([userId])
  @@index([stockId])
  @@map("favorites")
}

model History {
  id        String   @id @default(uuid())
  userId    String
  stockId   String
  type      String   @default("view") // view, search, etc.
  viewedAt  DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@index([stockId, viewedAt])
  @@index([userId, stockId, viewedAt]) // 중복 방지용
  @@map("history")
}

// ============================================
// Learning & Notes
// ============================================

model Learning {
  id            String   @id @default(uuid())
  userId        String
  concept       String
  question      String   @db.Text
  answer        String   @db.Text
  relatedStocks String[] // stock codes
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("learnings")
}

model Note {
  id        String   @id @default(uuid())
  userId    String
  title     String
  content   String   @db.Text
  tags      String[]
  chartData Json?    // 차트 데이터 (JSON)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([updatedAt])
  @@map("notes")
}

// ============================================
// Embeddings (RAG)
// ============================================

model Embedding {
  id        String   @id @default(uuid())
  content   String   @db.Text
  embedding Unsupported("vector(1536)")? // pgvector extension 필요
  metadata  Json?    // 추가 메타데이터
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("embeddings")
}

